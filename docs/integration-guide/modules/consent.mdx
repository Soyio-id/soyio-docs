import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import SequenceDiagram from '../../../src/components/SequenceDiagram';

# Obtención de consentimiento (Consent)

Integra un componente de consentimiento directamente en tu flujos para capturar uno más d consentimientos explícitos de tus usuarios.

Este módulo te permite cumplir con las regulaciones de protección de datos personales al obtener y registrar el consentimiento de tus usuarios de manera transparente, granular y sin interrumpir su experiencia de compra.

:::info[Información]
Por ahora, este servicio está disponible **sólo para el SDK Web**.
:::

<img src="/img/consent_example.png" alt="Consent Embed example" width="100%"/>

Cada vez que el usuario marque el checkbox de consentimiento, se **creará un registro de consentimiento mediante un token de acción**. Este token se puede usar para crear un registro de consentimiento en el backend y generar [evidencia del consentimiento otorgado](../concepts/agreement).

A grandes rasgos, el módulo Consent Box te permite:
- **Obtener consentimiento informado**: Registra la autorización explícita para el uso de datos. El usuario podrá revisar qué usos se harán de sus datos.
- **Integración fluida**: Embebe el componente directamente en tu interfaz y personalizalo con el *look and feel* de tu aplicación
- **Generar confianza**: Informamos al usuario sobre el uso de sus datos de manera transparente y clara, utilizando simbología sencilla y dando la opción de más información directamente en el componente.
- **Evidencia vinculante**: Genera evidencia del consentimiento otorgado mediante un [agreement y evidencia](../concepts/agreement).

:::tip
Puedes averiguar más acerca de nuestra simbología y taxonomía en la guía de [Agreement y evidencia](../concepts/agreement#taxonomía).
:::

## El proceso de consentimiento

El proceso de consentimiento embebido se compone de los siguientes pasos:

1. Se muestra el componente de consentimiento al usuario en un formulario o sección de tu interfaz
2. El usuario revisa y acepta los términos mediante un checkbox opt-in.
3. Se genera un **token de acción** cada vez que el usuario haga click un checkbox de consentimiento.
4. Al momento de persistir los datos del usuario, se envían los token de acción para crear un **registro de consentimientos** con evidencia del proceso.


## Configuración inicial

Para comenzar, deberás crear una [plantilla de consentimiento](../concepts/consent.md) que defina qué datos y permisos necesitas solicitar a tus usuarios. Para ello, utiliza el [endpoint de creación de plantillas de consentimiento](../../api/resources/create-consent-template.api.mdx).

:::warning[Importante]
Es importante que la plantilla de consentimiento describa de manera correcta los usos que se harán de los datos y que tenga al menos una finalidad y un periodo de retención.
:::

## Integración

El flujo que integrarás es el siguiente:

<SequenceDiagram
  actors={[
    { id: 'frontend', label: 'Frontend' },
    { id: 'backend', label: 'Backend' },
    { id: 'consent_box', label: 'Consent Box' },
    { id: 'soyio_api', label: 'Soyio API' },
  ]}
  actions={[
    {
      from: 'frontend',
      to: 'consent_box',
      label: 'Inicializar componente con el `template_id` correspondiente'
    },
    {
      from: 'consent_box',
      to: 'frontend',
      label: 'Envío de token de acción mediante el evento `CONSENT_CHECKBOX_CHANGE`',
      isDashed: true,
    },
    {
      from: 'frontend',
      to: 'consent_box',
      label: 'Obtención del valor del token de acción de consentimiento (opcional)',
    },
    {
      from: 'frontend',
      to: 'backend',
      label: 'Enviar action_token'
    },
    {
      from: 'backend',
      to: 'soyio_api',
      label: 'Crear registro de consentimiento'
    },
    {
      from: 'soyio_api',
      to: 'backend',
      label: 'Retorna información del registro de consentimiento'
    },
  ]}
/>

### Pre requisitos

1. Tener el [SDK](../quickstart.mdx) instalado en tu sitio o aplicación.
2. Tener una [plantilla de consentimiento](../../api/resources/create-consent-template.api.mdx) creada.

## Paso a paso

### 1. Inicializa el componente en tu frontend

Inicializa el componente de consentimiento en tu interfaz mediante el SDK de Soyio, utilizando el `consentTemplateId` de la plantilla de consentimiento que creaste previamente. Estos empiezan con el prefijo `constpl_`.

<Tabs>
    <TabItem value="web" label="SDK Web" default>
        ```jsx
        import { ConsentBox } from "@soyio/soyio-widget";

        // Configuración del componente
        const consentOptions = {
            consentTemplateId: "<consent_template_id>",
            onEvent: (data) => console.log(data),
            isSandbox: false,
            appearance: {} // Optional
        };

        // Montar el componente
        document.addEventListener("DOMContentLoaded", () => {
            new ConsentBox(consentOptions).mount("#consent-box-container");
        });
        ```

        ```html
        <!-- HTML -->
        <div id="consent-box-container"></div>
        ```
    </TabItem>
</Tabs>

:::info
Este módulo está diseñado para integrarse de manera nativa en tu interfaz y podrás personalizarlo con el look and feel de tu aplicación. Revisa la sección de [personalización](#personalización) para más detalles.
:::

### 2. Escucha los eventos del componente o consulta el estado de consentimiento

El parámetro de `actionToken` es necesario para crear el registro de consentimiento luego en el siguiente paso. Para ello, tienes dos opciones:

#### 2.1 Escuchar el evento `CONSENT_CHECKBOX_CHANGE`

El componente emitirá eventos cuando el usuario interactúe con él. El evento principal es `CONSENT_CHECKBOX_CHANGE` que incluye:

```typescript
{
    eventName: 'CONSENT_CHECKBOX_CHANGE',
    isSelected: boolean,
    actionToken: string
}
```

De esta manera, puedes obtener el `actionToken` en el instante en que el usuario haga click en el checkbox.

#### 2.2 Consultar el estado de consentimiento directamente

También puedes consultar por el valor del consentimiento (útil para submits de formularios) mediante la función `getActionToken` del SDK. Este valor puede ser un string correspondiente al `actionToken` o `null` dependiendo si el usuario ha hecho click en el checkbox o no.

```typescript
const actionToken = await ConsentBox.getActionToken();
```

### 3. Crea el registro de consentimiento

Una vez que tengas el `actionToken`, puedes crear el registro de consentimiento mediante el [endpoint de creación de acción de consentimiento](../../api/resources/create-consent-action.api.mdx).

Opcionalmente, puedes agregar el `userReference` para asociar el consentimiento con un usuario específico de tu sistema.

```json
POST /api/v1/consent_actions

{
    "action_token": "<action_token>",
    "user_reference": "<identificador_usuario>" // Opcional
}
```

#### 3.1 Registro agrupado

Opcionalmente, puedes crear un registro de consentimiento agrupado (por ejemplo, cuando se termina un formulario o para capturar varios tipos de consentimientos en un solo submit) mediante el [endpoint de commit de consentimientos](../../api/resources/create-consent-commit.api.mdx). Esto te permitirá agrupar varios action tokens en un solo registro de consentimiento.

```json
POST /api/v1/consent_commits

{
    "consent_actions": [
      { "action_token": "<action_token_1>" },
      { "action_token": "<action_token_2>" }
    ],
    "user_reference": "<identificador_usuario>" // Opcional
}
```

Una vez se haya creado el registro de consentimiento, se retornará la acción (o lista de acciones) creada(s). En cada una de ellas, habrá un `entity_id`, junto con el `user_reference` (en el caso de que se haya proporcionado), que representa el identificador único del usuario que otorgó el consentimiento.

## Personalización (Opcional)

El componente puede ser personalizado para poder adaptarse a tu interfaz mediante variables de CSS declaradas en el objeto `appearance` del SDK. Por ejemplo:

```jsx
const consentOptions = {
    consentTemplateId: "<consent_template_id>",
    appearance: {
      variables: {
          fontFamily: 'system-ui, sans-serif',
          colorPrimary: '#f54c27',
          colorBackground: '#ffffff',
      },
      rules : {
          '.Checkbox': {
            border: '1px solid var(--colorPrimary)',
            backgroundColor: 'var(--colorBackground)',
          }
      }
};
```


:::tip[Pro Tip]
Para obtener más información sobre las variables y reglas de personalización, consulta la [documentación oficial del SDK web de Soyio](https://docs.soyio.co/docs/soyio-widget/customization).
:::

:::warning[Importante]
Asegúrate de mantener los elementos de accesibilidad como el contraste adecuado y el tamaño de fuente legible al personalizar el componente.
:::
